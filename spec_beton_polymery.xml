<?xml version="1.0" encoding="utf-8"?>
<copilot_spec lang="en">
  <meta>
    <title>Functional Specification - Polymer Concrete Calculator (Mobile-first)</title>
    <version>1.0</version>
    <date>2025-11-28</date>
    <author>Requested by user</author>
    <description>Comprehensive XML specification for a lightweight, mobile-first calculator built with Svelte 5 and Tailwind. The tool calculates material quantities (in grams) for polymer concrete preparation based on user-provided mold volumes. This specification includes UX, UI, data models, logic, validations, and edge-case behaviors. No coding instructions are included.</description>
  </meta>

  <business_requirements>
    <requirement id="BR-01">The user can manage a "Mold Library" where each mold has a name, volume, and active state.</requirement>
    <requirement id="BR-02">Calculation formula: totalGrams = sum(active_molds_volume) * 2. Fixed percentages: Water 20%, Bond 5%, White Cement 15%, Putty 60%.</requirement>
    <requirement id="BR-03">Percentages are fixed in this version; the user cannot modify them.</requirement>
    <requirement id="BR-04">The interface must be mobile-first, clear, responsive, and show results in real time based on active molds.</requirement>
    <requirement id="BR-05">Application state (mold library) should persist in localStorage for quick reuse.</requirement>
  </business_requirements>

  <user_personas>
    <persona id="P-1">
      <name>Construction Worker / Field User</name>
      <goals>Quick calculation of multiple mold volumes, accurate gram results, minimal typing on mobile devices.</goals>
      <constraints>Possibly wearing gloves, bright sunlight, using a rugged mobile device.</constraints>
    </persona>
    <persona id="P-2">
      <name>DIY Hobbyist</name>
      <goals>Convenience, understanding how the mixture is composed, and the ability to reuse previous inputs.</goals>
    </persona>
  </user_personas>

  <ux_ui>
    <general>
      <orientation>portrait-first</orientation>
      <layout>single_screen</layout>
      <max_width>max-w-sm</max_width>
      <spacing>consistent padding and spacing</spacing>
      <theme>light (optional dark mode)</theme>
      <language>English (LTR)</language>
    </general>

    <input_section>
      <title>Mold Library</title>
      <description>List of saved molds. Each row represents a mold with name, volume, and toggle state.</description>
      <controls>
        <control name="add_mold_button" label="+" hint="Adds a new mold to library"/>
        <control name="name_input" type="text" placeholder="Name (e.g. Cube)" aria_label="Mold name"/>
        <control name="volume_input" type="number" inputmode="decimal" placeholder="Volume (ml)" aria_label="Mold volume in milliliters"/>
        <control name="delete_button" icon="trash" aria_label="Delete mold" tooltip="Delete"/>
        <control name="clear_all" display="small_link" label="Clear All" hint="Clears all molds and stored state"/>
      </controls>
      <behaviour>
        <add_flow>User enters Name and Volume, then clicks Add. New mold is Active by default.</add_flow>
        <toggle_flow>Clicking a mold row toggles its Active state (Green = Active, Gray = Inactive).</toggle_flow>
        <validation>Volume required. Name optional (defaults to "Mold #N"). Negative numbers not allowed.</validation>
      </behaviour>
    </input_section>

    <summary_section>
      <title>Total Active Volume</title>
      <display>Displayed above the results. Shows sum of volumes of all ACTIVE molds.</display>
      <format>"Total Active Volume: 1,230 ml" with thousands separators.</format>
    </summary_section>

    <results_section>
      <title>Results (grams)</title>
      <items>
        <item name="water" percent="0.20" display_name="Water" rounding="nearest" unit="g" color="sky"/>
        <item name="bond" percent="0.05" display_name="Bond" rounding="nearest" unit="g" color="emerald (green)"/>
        <item name="white_cement" percent="0.15" display_name="White Cement" rounding="nearest" unit="g" color="white"/>
        <item name="putty" percent="0.60" display_name="Putty" rounding="nearest" unit="g" color="slate (gray)"/>
      </items>
      <display_rules>
        <live_update>All results update instantly as the user toggles molds or adds new ones.</live_update>
        <formatting>Values are rounded to whole grams. Values under 1g are displayed as 0 unless precision is required.</formatting>
        <emphasis>Numeric values highlighted; unit placed next to value.</emphasis>
      </display_rules>
    </results_section>

    <microinteractions>
      <on_add_mold>Short fade-in animation for new rows.</on_add_mold>
      <on_toggle>Visual state change (Green <-> Gray) with smooth transition.</on_toggle>
      <on_delete_mold>Row slides up and disappears; an undo toast appears for 3.5 seconds.</on_delete_mold>
      <on_invalid_input>Inline error message beneath input; red border for the field.</on_invalid_input>
    </microinteractions>

    <accessibility>
      <labels>All controls and fields have clear ARIA labels.</labels>
      <contrast>Color choices must meet WCAG AA contrast ratios.</contrast>
      <keyboard>All operations, including add/delete/toggle, accessible via keyboard/tab navigation.</keyboard>
      <screen_reader>Screen readers announce row index, name, volume, active state, and updated results.</screen_reader>
    </accessibility>
  </ux_ui>

  <data_model>
    <entities>
      <entity name="MoldRow">
        <field name="id" type="string" description="Local UUID"/>
        <field name="name" type="string" description="User defined name or default"/>
        <field name="volume_ml" type="number" description="Volume in milliliters"/>
        <field name="active" type="boolean" description="Whether included in calculation"/>
        <field name="created_at" type="datetime"/>
      </entity>
      <entity name="AppState">
        <field name="molds" type="MoldRow[]"/>
        <field name="total_volume_ml" type="number" description="Sum of active molds"/>
        <field name="results" type="object" description="Grams per material"/>
      </entity>
    </entities>

    <persistence>
      <localStorage>
        <key>poly_concrete_state_v2</key>
        <fields_to_store>molds, last_updated</fields_to_store>
        <ttl>Persistent until explicitly cleared by the user.</ttl>
      </localStorage>
    </persistence>
  </data_model>

  <calculation_logic>
    <overview>All computations follow deterministic steps to ensure consistency.</overview>
    <steps>
      <step id="C-1" description="Compute totalVolumeMl = sum(mold.volume_ml)"/>
      <step id="C-2" description="Compute totalGrams = totalVolumeMl * 2"/>
      <step id="C-3" description="For each material: grams = round(totalGrams * percent)" rounding="nearest_integer"/>
      <step id="C-4" description="Final normalization: ensure the sum of calculated grams equals totalGrams. If not, adjust the material with the highest percentage (Putty) by ±1g."/>
    </steps>

    <examples>
      <example>
        <input>Mold A=320 ml, Mold B=150 ml</input>
        <calc>totalVolumeMl=470 → totalGrams=940</calc>
        <output>
          <water>188 g</water>
          <bond>47 g</bond>
          <white_cement>141 g</white_cement>
          <putty>564 g</putty>
        </output>
      </example>
    </examples>
  </calculation_logic>

  <edge_cases_and_validation>
    <empty_state>If no molds are defined: total volume = 0; results all 0; display helper text "Add a mold to begin".</empty_state>
    <non_numeric>Non-numeric inputs produce an inline error and the row is excluded from calculation.</non_numeric>
    <negative_values>Negative values are invalid. Automatically corrected to 0 with error notice.</negative_values>
    <very_large_values>Maximum supported per mold: 100,000 ml (configurable). If exceeded, show warning and allow user confirmation.</very_large_values>
    <decimal_input>Decimal input supported up to 3 decimal places before rounding.</decimal_input>
  </edge_cases_and_validation>

  <analytics_and_logging>
    <events>
      <event>add_mold</event>
      <event>delete_mold</event>
      <event>clear_all</event>
      <event>calculation_performed</event>
    </events>
    <privacy>No personal data collected; analytics optional and opt-in.</privacy>
  </analytics_and_logging>

  <testing>
    <unit_tests>
      <test_case id="T1">Single mold: 100 ml → totalGrams=200 → Water=40, Bond=10, Cement=30, Putty=120.</test_case>
      <test_case id="T2">Multi-mold calculation: example provided above.</test_case>
      <test_case id="T3">Rounding integrity: ensure normalized sum equals totalGrams.</test_case>
      <test_case id="T4">Empty row: treated as 0.</test_case>
    </unit_tests>

    <e2e_tests>
      <flow>Add 4 molds, edit one, delete another, trigger undo, refresh page, verify localStorage restore.</flow>
    </e2e_tests>
  </testing>

  <localization>
    <default_language>en-US</default_language>
    <strings>
      <string id="add_mold">+ Add Mold</string>
      <string id="total_volume">Total Volume</string>
      <string id="results">Results (g)</string>
      <string id="empty_prompt">Add a mold to begin</string>
      <string id="clear_all">Clear All</string>
      <string id="undo">Undo</string>
    </strings>
  </localization>

  <deliverables>
    <deliverable>This XML specification — intended for Copilot or other requirement parsers.</deliverable>
    <deliverable>Optional wireframe describing the single-screen layout.</deliverable>
    <deliverable>Test cases and edge-case scenarios.</deliverable>
  </deliverables>

  <notes>
    <note>Phase 1: fixed percentages only.</note>
    <note>Phase 2 (future): advanced settings for custom percentages, alternate units, recipe export/import.</note>
  </notes>

</copilot_spec>
